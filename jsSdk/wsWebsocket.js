"use strict";var _createClass=function(){function o(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,n,t){return n&&o(e.prototype,n),t&&o(e,t),e}}();function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}!function(e,n){"function"==typeof define&&define.amd?define([],n):"undefined"!=typeof module&&module.exports?module.exports=n():e.ReconnectingWebSocket=n()}(window,function(){if("WebSocket"in window)return e.prototype.onopen=function(e){},e.prototype.onclose=function(e){},e.prototype.onconnecting=function(e){},e.prototype.onmessage=function(e){},e.prototype.onerror=function(e){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e;function e(e,n,t){var o={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};for(var i in t||(t={}),o)void 0!==t[i]?this[i]=t[i]:this[i]=o[i];this.url=e,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var s,r=this,c=!1,a=!1,u=document.createElement("div");function d(e,n){var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!1,!1,n),t}u.addEventListener("open",function(e){r.onopen(e)}),u.addEventListener("close",function(e){r.onclose(e)}),u.addEventListener("connecting",function(e){r.onconnecting(e)}),u.addEventListener("message",function(e){r.onmessage(e)}),u.addEventListener("error",function(e){r.onerror(e)}),this.addEventListener=u.addEventListener.bind(u),this.removeEventListener=u.removeEventListener.bind(u),this.dispatchEvent=u.dispatchEvent.bind(u),this.open=function(o){if((s=new WebSocket(r.url,n||[])).binaryType=this.binaryType,o){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else u.dispatchEvent(d("connecting")),this.reconnectAttempts=0;r.debug;var e=s,t=setTimeout(function(){r.debug,a=!0,e.close(),a=!1},r.timeoutInterval);s.onopen=function(e){clearTimeout(t),r.debug,r.protocol=s.protocol,r.readyState=WebSocket.OPEN,r.reconnectAttempts=0;var n=d("open");n.isReconnect=o,o=!1,u.dispatchEvent(n)},s.onclose=function(e){if(clearTimeout(t),s=null,c)r.readyState=WebSocket.CLOSED,u.dispatchEvent(d("close"));else{r.readyState=WebSocket.CONNECTING;var n=d("connecting");n.code=e.code,n.reason=e.reason,n.wasClean=e.wasClean,u.dispatchEvent(n),o||a||(r.debug,u.dispatchEvent(d("close")));var t=r.reconnectInterval*Math.pow(r.reconnectDecay,r.reconnectAttempts);setTimeout(function(){r.reconnectAttempts++,r.open(!0)},t>r.maxReconnectInterval?r.maxReconnectInterval:t)}},s.onmessage=function(e){r.debug;var n=d("message");n.data=e.data,u.dispatchEvent(n)},s.onerror=function(e){r.debug,u.dispatchEvent(d("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(e){if(s)return r.debug,s.send(e);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,n){void 0===e&&(e=1e3),c=!0,s&&s.close(e,n)},this.refresh=function(){s&&s.close()}}}),function(e,n){"function"==typeof define&&define.amd?define([],n):"undefined"!=typeof module&&module.exports?module.exports=n():e.Strategies=n()}(window,function(){return function(){function e(){_classCallCheck(this,e),this.collection={}}return _createClass(e,[{key:"get",value:function(){return this.collection}},{key:"add",value:function(e,n){this.collection[e]=n}},{key:"execute",value:function(e,n){this.collection[e]&&this.collection[e](n)}}]),e}()}),function(e,n){"function"==typeof define&&define.amd?define([],n):"undefined"!=typeof module&&module.exports?module.exports=n():e.wsWebsocket=n()}(window,function(){return function(){function n(e){_classCallCheck(this,n),this.initParam={serverIP:"",websocketPort:"",httpPort:"",isHttps:!1},this.socket=null,this.heartInterval=null,this.initParam=e,this.handles=null,this.userInfo={serverToken:null,token:null,time:null,headerImg:null,userId:null,nick:null},this.config={proxy:""},this.currentChatStatus={roomId:null,userId:null},this.onReadySuccess=new Function,this.onReadyError=new Function,this.onGetServerInfoSuccess=new Function,this.onGetServerInfoError=new Function,this.onGetServerNotification=new Function,this.uploadResList={},this.onRecieveMessage=new Function,this.onJoinRoomSuccess=new Function,this.onJoinRoomError=new Function,this.onOutRoomSuccess=new Function,this.onOutRoomError=new Function,this.onGetRoomUserListSuccess=new Function,this.onGetRoomUserListError=new Function,this.onOnline=new Function,this.onOffline=new Function,this._ondebug=new Function,this._onopen=new Function,this._onconnecting=new Function,this._onmessage=new Function,this._onclose=new Function,this._onerror=new Function}return _createClass(n,[{key:"init",value:function(e){var t=this;if(this.initParam)if(this.initParam.serverIP&&this.initParam.websocketPort&&this.initParam.httpPort)if(e)if(e.token&&e.headerImg&&e.userId&&e.nick)if(e.proxy)if(e.proxy.authProxy&&e.proxy.msgResProxy){if(!this.socket){var n=this._getWebsocketUrl();this.socket=new ReconnectingWebSocket(n,null,{debug:!0,reconnectInterval:3e3,maxReconnectAttempts:50})}this.userInfo=e,this.userInfo.time=(new Date).getTime(),this.handles=this._initHandles(),this.socket.onopen=function(){t._ondebug("res","onopen:连接到服务器",t._formatDate()),t._onopen()},this.socket.onconnecting=function(){t._ondebug("res","onconnecting:重新连接服务器",t._formatDate()),t._stopHeart(),t._onconnecting(),t.onOffline()},this.socket.onmessage=function(e){try{var n=JSON.parse(e.data);if(1!==n.code&&t._ondebug("res",e.data,t._formatDate()),350===n.code||351===n.code)return void t.handles.execute("notification",n);t.handles.execute(n.code,n)}catch(e){}},this.socket.onclose=function(){t._ondebug("res","onclose:连接关闭",t._formatDate()),t._stopHeart(),t._onclose(),t.onOffline()},this.socket.onerror=function(){t._ondebug("res","onerror:连接失败",t._formatDate()),t._stopHeart(),t._onerror(),t.onOffline()}}else this.onReadyError("网关配置信息错误");else this.onReadyError("缺少网关配置信息");else this.onReadyError("建权用户信息错误");else this.onReadyError("缺少建权用户信息");else this.onReadyError("基本配置信息错误");else this.onReadyError("缺少基本配置信息")}},{key:"on",value:function(e,n,t){if(n&&"function"==typeof n||(n=new Function),t&&"function"==typeof t||(t=new Function),"ready"===e)return this.onReadySuccess=n,void(this.onReadyError=t);"notification"===e&&(this.onGetServerNotification=n),"recievemessage"===e&&(this.onRecieveMessage=n),"debug"===e&&(this._ondebug=n),"online"===e&&(this.onOnline=n),"offline"===e&&(this.onOffline=n),"open"!==e?"connecting"!==e?"message"!==e?"close"!==e?"error"!==e||(this._onerror=n):this._onclose=n:this._onmessage=n:this._onconnecting=n:this._onopen=n}},{key:"getUserInfo",value:function(){return this.userInfo}},{key:"getRoomId",value:function(){return this.currentChatStatus.roomId}},{key:"destroy",value:function(e){this._destroy(),e&&e()}},{key:"getServerInfo",value:function(e,n){this._sendMessage(115,{}),e&&"function"==typeof e&&(this.onGetServerInfoSuccess=e),n&&"function"==typeof n&&(this.onGetServerInfoError=n)}},{key:"joinRoom",value:function(e,n,t){var o={roomId:e};this._sendMessage(102,o),n&&"function"==typeof n&&(this.onJoinRoomSuccess=n),t&&"function"==typeof t&&(this.onJoinRoomError=t)}},{key:"outRoom",value:function(e,n){this._sendMessage(104,{}),e&&"function"==typeof e&&(this.onOutRoomSuccess=e),n&&"function"==typeof n&&(this.onOutRoomError=n)}},{key:"getRoomUserList",value:function(e,n,t){var o={roomId:e};this._sendMessage(103,o),n&&"function"==typeof n&&(this.onGetRoomUserListSuccess=n),t&&"function"==typeof t&&(this.onGetRoomUserListError=t)}},{key:"sendRoomMessage",value:function(e,n,t){var o={body:e};t&&(o.roomId=t),this._sendMessage(110,o),n&&"function"==typeof n&&n()}},{key:"sendP2PMessage",value:function(e,n,t){if(n){var o={userId:n,msg:e};this._sendMessage(111,o),t&&"function"==typeof t&&t()}}},{key:"upload",value:function(e){window.cordova||this._uploadPC(e)}},{key:"_uploadPC",value:function(t){var o=this;if(t&&t.file){var e=this._uuid(),n=this.userInfo.userId,i=this._getUploadUrl();t.before(e),this._ondebug("req","准备上传文件："+t.file.name,this._formatDate()),t.recieve&&(this.uploadResList[e]=t.recieve);var s=new FormData;s.append("clientFileId",e),s.append("userId",n),s.append("upfile",t.file);var r=new XMLHttpRequest;r.upload.addEventListener("progress",function(e){if(e.lengthComputable){var n=Math.round(e.loaded/e.total*100);t.progress(n,e.loaded,e.total),o._ondebug("req","上传文件进度"+n+"%",o._formatDate())}},!1),r.addEventListener("load",t.success,!1),r.addEventListener("error",t.error,!1),r.addEventListener("abort",t.error,!1),r.open("POST",i,!0),r.send(s)}}},{key:"_uuid",value:function(){return"xxxxxxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=16*Math.random()|0;return("x"==e?n:3&n|8).toString(16)})}},{key:"_initHandles",value:function(){var n=this,e=new Strategies;return e.add(1,function(e){n.userInfo.time=e.time}),e.add(300,function(e){n._sendMessage(101,n.userInfo)}),e.add(301,function(e){n._onMessage(e,function(e){n._startHeart(),n.userInfo.serverToken=e.serverToken,n.currentChatStatus.roomId&&n.joinRoom(n.currentChatStatus.roomId),n.onReadySuccess&&(n.onReadySuccess(),n.onReadySuccess=null),n.onOnline()},function(){n.onReadyError("建权失败"),n.onOffline()})}),e.add(302,function(e){n._onMessage(e,function(e){n.currentChatStatus.roomId=e.roomId,n.onJoinRoomSuccess(e)},n.onJoinRoomError)}),e.add(304,function(e){n._onMessage(e,function(e){n.currentChatStatus.roomId=null,n.onOutRoomSuccess(e)},n.onOutRoomError)}),e.add(303,function(e){n._onMessage(e,n.onGetRoomUserListSuccess,n.onGetRoomUserListError)}),e.add(310,function(e){n._onMessage(e,n.onRecieveMessage,function(){},1)}),e.add(311,function(e){n._onMessage(e,n.onRecieveMessage,function(){},2)}),e.add(315,function(e){n._onMessage(e,n.onGetServerInfoSuccess,n.onGetServerInfoError)}),e.add("notification",function(e){n._onMessage(e,n.onGetServerNotification)}),e.add(355,function(e){n._onMessage(e,function(e){n.uploadResList[e.clientFileId]&&n.uploadResList[e.clientFileId](e)})}),e}},{key:"_onMessage",value:function(e,n,t,o){0===e.status?n&&n(e,o):t&&t()}},{key:"_getUploadUrl",value:function(){var e="http://";return e+=this.initParam.serverIP+":"+this.initParam.httpPort+"/chatApplication/ContentUpload/chat/upload.do"}},{key:"_getWebsocketUrl",value:function(){var e="ws://";return this.initParam.isHttps&&(e="wss://"),e+=this.initParam.serverIP+":"+this.initParam.websocketPort+"/chatApplication/websocket"}},{key:"_formatDate",value:function(){var e=new Date;e.getFullYear(),e.getMonth(),e.getMonth(),e.getDate(),e.getDate();return(10<=e.getHours()?e.getHours():"0"+e.getHours())+":"+(10<=e.getMinutes()?e.getMinutes():"0"+e.getMinutes())+":"+(10<=e.getSeconds()?e.getSeconds():"0"+e.getSeconds())}},{key:"_sendMessage",value:function(e,n,t){if(this.socket){var o={code:e,body:n,version:1};t&&(o.extend=t),this.socket.send(JSON.stringify(o)),100!==e&&this._ondebug("req",JSON.stringify(o),this._formatDate())}}},{key:"_startHeart",value:function(){var e=this,n={};this._sendMessage(100,n),this.heartInterval=setInterval(function(){e._sendMessage(100,n)},1e4)}},{key:"_stopHeart",value:function(){clearInterval(this.heartInterval),this.heartInterval=null}},{key:"_destroy",value:function(){this.socket&&(this._stopHeart(),this.socket.close(),this.socket=null,this.userInfo=null,this.currentChatStatus={roomId:null,userId:null})}}]),n}()});